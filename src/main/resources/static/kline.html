<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>BTC/USDT K線圖</title>
    <style>
        #chart {
            width: 100%;
            height: 500px;
        }
    </style>
    <!-- 引入 TradingView Lightweight Charts 庫 -->
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
<h1>BTC/USDT K線圖</h1>
<div id="chart"></div>

<script>
    // 創建圖表
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        width: document.body.clientWidth,
        height: 500,
        layout: {
            backgroundColor: '#FFFFFF',
            textColor: '#000',
        },
        grid: {
            vertLines: {
                color: '#e1e1e1',
            },
            horzLines: {
                color: '#e1e1e1',
            },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#AAA',
        },
        timeScale: {
            borderColor: '#AAA',
            timeVisible: true,
            secondsVisible: false,
        },
    });

    const candleSeries = chart.addCandlestickSeries();
    let originalData = []; // 用來儲存K線數據

    // 設置 WebSocket 連接
    const socket = new WebSocket('ws://localhost:8081/ws/kline'); // 替換為你的WebSocket地址

    // 監聽WebSocket消息
    socket.onmessage = function(event) {
        const message = JSON.parse(event.data);
        console.log(message);

        // 檢查是否是歷史數據
        if (Array.isArray(message)) {
            // 如果是歷史數據，更新圖表
            originalData = message.map(d => ({
                time: d.time, // 確保時間是秒級Unix時間戳
                open: d.open,
                high: d.high,
                low: d.low,
                close: d.close
            }));
            console.log(originalData);
            candleSeries.setData(originalData); // 設置歷史數據到圖表
        }
        // } else if (message.symbol === 'BTCUSDT') {
        //     // 如果是實時的當前K線數據，更新最後一根K線
        //     const lastCandle = { ...originalData[originalData.length - 1] };
        //
        //     // 假設當前消息包含最新的價格、最高價和最低價，更新K線
        //     lastCandle.high = Math.max(lastCandle.high, message.high);
        //     lastCandle.low = Math.min(lastCandle.low, message.low);
        //     lastCandle.close = message.close; // 更新 close 價格為最新成交價
        //
        //     // 更新圖表
        //     candleSeries.update(lastCandle);
        // }
    };



    // 錯誤處理
    socket.onerror = function(error) {
        console.error('WebSocket 出現錯誤: ', error);
    };

    // WebSocket關閉處理
    socket.onclose = function() {
        console.log('WebSocket 連接已關閉');
    };

    // 監聽頁面縮放，適應圖表大小
    window.addEventListener('resize', () => {
        chart.applyOptions({ width: document.body.clientWidth });
    });
</script>
</body>
</html>
